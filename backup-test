#!/bin/bash

scriptdir=`dirname $0`
cd $scriptdir

printWidth=20

testfiles=`ls tests.d/*.test`
tests=''
for f in $testfiles; do
    tst=`basename -s .test $f`
    tests="$tests $tst"
done

create-vol () {
    hdiutil create -megabytes 10 -fs 'Journaled HFS+' \
            -volname $1 -type SPARSE -attach ./$1.dmg
    sudo fsaclctl -p /Volumes/CopyFrom -e
}

create-all () {
    for t in $tests; do
        tnice=${t:2}
        printf "Creating: %${printWidth}s ..." "$tnice"
        if [ -d "$1/$t" ]; then
            bash test-runner tests.d/$t.test clean $1/$t || true
            rm -Rf "$1/$t" || true
        fi
        mkdir $1/$t
        bash test-runner tests.d/$t.test create $1/$t \
            && echo " ok" \
            || echo " FAIL"
    done
}

clean-all () {
    for t in $tests; do
        tnice=${t:2}
        printf "Cleaning: %${printWidth}s\n" "$tnice"
        if [ -d "$1/$t" ]; then
            bash test-runner tests.d/$t.test clean $1/$t || true
            rm -Rf "$1/$t" || true
        fi
    done
}

verify-all () {
    for t in $tests; do
        tnice=${t:2}
        printf "Verifying: %${printWidth}s ..." "$tnice"
        bash test-runner tests.d/$t.test verify $2/$t $1/$t \
            && echo " ok" \
            || echo " FAIL"
    done
}

# Compare a single pair of files for all known properties.
compare-all () {
    for t in $tests; do
        tnice=${t:2}
        echo -n "Comparing: %${printWidth}s ..." "$tnice"
        bash test-runner tests.d/$t.test compare $1 $2 \
            && echo " ok" \
            || echo " FAIL"
    done
}

copy () {
    if [ -x copiers.d/$1 ]; then
        # Make sure there's no trailing /
        src="`dirname $2`/`basename $2`"
        dst="`dirname $3`/`basename $3`"
        mkdir $dst/$1
        copy-runner copiers.d/$1 $src $dst/$1
    else
        echo "Can't execute copiers.d/$1"
        echo "   File doesn't exist or isn't executable."
        exit 1
    fi
}

case $1 in
    create-all|create-vol|clean-all)
        $1 $2
    ;;
    verify-all|compare-all|copy)
        $1 $2 $3
    ;;
    *)
        echo "Ops: "
        echo "   create-vol, create-all, verify-all, "
        echo "   compare-all, clean-all, copy"
        exit 1
    ;;
esac
