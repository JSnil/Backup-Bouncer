#!/bin/bash

#set -x

scriptdir=`dirname $0`
cd $scriptdir
export PATH="`pwd`/util:/Developer/Tools:$PATH:."

export printWidth=20

testfiles=`ls tests.d/*.test`
tests=''
for f in $testfiles; do
    tst=`basename -s .test $f`
    tests="$tests $tst"
done

copyfiles=`ls copiers.d/*.cp`
copiers=''
for f in $copyfiles; do
    cpf=`basename -s .cp $f`
    copiers="$copiers $cpf"
done

create-vol () {
    hdiutil create -size 40m -fs 'Journaled HFS+' \
            -volname $1 -type SPARSE ./$1
    hdiutil attach -owners on ./$1.sparseimage
    sudo fsaclctl -p /Volumes/$1 -e
    touch /Volumes/$1/backup-test-vol
}

check-vol () {
    if [ -e $1/backup-test-vol ]; then
        return 0
    else
        echo "$1 is not a backup-test volume!  Aborting." 1>&2
        exit 1
    fi
}

clean () {
    #check-vol $1
    for t in $tests; do
        tnice=${t:2}
        printf "Cleaning: %${printWidth}s\n" "$tnice"
        if [ -d "$1/$t" ]; then
            bash util/test-runner tests.d/$t.test clean $1/$t || true
            sudo rm -Rf "$1/$t" || true
        fi
    done
}

create () {
    check-vol $1
    clean $1
    for t in $tests; do
        tnice=${t:2}
        printf "Creating: %${printWidth}s ... " "$tnice"
        mkdir $1/$t
        bash util/test-runner tests.d/$t.test create $1/$t \
            && echo ok \
            || echo FAIL
    done
}

verify () {
    local src="$1"
    local dst="$2"
    if [ ! -e "$2" ]; then
        echo "Copier dir '$2' does not exist"
        return 1
    fi
    local code=`cat $dst/exit-code | awk '{print $1}'`
    if [ ! "$code" = "0" ]; then
        echo "This copier exited with error code $code"
    fi
    if [ ! "`wc -c $dst/log | awk '{print $1}'`" = "0" ]; then
        echo "This copier produced log output in:"
        echo "   $dst/log"
    fi
    for t in $tests; do
        local tnice=${t:2}
        if [ ! -e "$dst/$t" ]; then
            echo "Test dir '$dst/$t' does not exist"
            continue
        fi
        printf "Verifying: %${printWidth}s ... " "$tnice"
        bash util/test-runner tests.d/$t.test verify $dst/$t $src/$t \
            && echo ok \
            || echo FAIL
    done
}

# Compare a single pair of files for all known properties.
compare () {
    for t in $tests; do
        tnice=${t:2}
        printf "Comparing: %${printWidth}s ... " "$tnice"
        bash util/test-runner tests.d/$t.test compare $1 $2 \
            && echo ok \
            || echo FAIL
    done
}

copy () {
    check-vol $1
    check-vol $2
    
    # Make sure there's no trailing /
    local src="`dirname $1`/`basename $1`"
    local dst="`dirname $2`/`basename $2`"
    echo "src = $src"
    echo "dst = $dst"
    #echo Remounting with owners enabled
    # This requires the actual mount point.
    srcDisk=`stat -f "%Sd" $src`
    dstDisk=`stat -f "%Sd" $dst`
    echo Enabling owners on disks
    sudo mount -uvo perm /dev/$srcDisk
    sudo mount -uvo perm /dev/$dstDisk
    echo -n Cleaning
    for c in $copiers; do
        echo -n .
        clean $dst/$c > /dev/null
        sudo rm -Rf $dst/$c
    done
    echo
    for c in $copiers; do
        cnice=${c:3}
        printf "Copying with: %${printWidth}s ... " "$cnice"
        mkdir $dst/$c
        bash util/copy-runner copiers.d/$c.cp $src $dst/$c
        code=$?
        echo $code > $dst/$c/exit-code
        [ "$code" = "0" ] && echo ok \
            || echo FAIL
    done
    for c2 in $copiers; do
        cnice=${c2:3}
        echo
        echo "------------------ $cnice ------------------"
        if [ -e $dst/$c2/skipped ]; then
            echo "    This copier was skipped"
        else
            verify $src $dst/$c2
        fi
    done
}

case $1 in
    create|create-vol|clean)
        $1 $2
    ;;
    compare)
        $1 $2 $3
    ;;
    verify|copy)
        if [ "$2" = "detail" ]; then
            export DETAIL=1
            $1 $3 $4
        else
            $1 $2 $3
        fi
    ;;
    *)
        echo "Usage: 
        $0 create-vol volname
                Create and mount a disk image suitable for testing.
                
        $0 create dir
                Populate dir with test files/directories.
                
        $0 copy [detail] srcdir dstdir
                For each copier, copy from srcdir to dstdir/copier-name,
                then verify each copy.
        
        $0 verify [detail] srcdir dstdir
                Test the validity of the files in dstdir, which should be
                copies of those in srcdir.  srcdir should contain a directory
                created by '$0 create srcdir'.  If detail is specified, 
                results of sub-tests will be shown individually.
                
        $0 compare srcfile dstfile
                Test the two files for equality based on all tests in the
                test suite.
        
        $0 clean dir
                Remove all test files from dir.  For various reasons, 
                simply running 'rm -rf dir' will not work.
        
        Note that many operations require elevated privileges, so you may be
        prompted for your password.
        
        The typical usage will be something like:
        1. Create files
            $0 create-vol Src
            $0 create-vol Dst
            $0 create /Volumes/Src
        
        2. Run test suite (as root!)
            $0 copy detail /Volumes/Src /Volumes/Dst
            # That filled /Volumes/Dst with a subdirectory for each copier.
            # To verify the results from a single copy again:
            $0 verify detail /Volumes/Src /Volumes/Dst/10-rsync-apple
            
        3. Or maybe you want to test a GUI copier
            # Use SuperDuper! to copy to /Volumes/SDDst, then:
            $0 verify detail /Volumes/Src /Volumes/SDDst
        "
        exit 1
    ;;
esac
